name: VetSync API – CI

on:
  push:
    branches: [main, develop]
    paths:
      - "vet-sync-api/**"
      - ".github/workflows/api-ci.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "vet-sync-api/**"
      - ".github/workflows/api-ci.yml"

defaults:
  run:
    working-directory: vet-sync-api

jobs:
  # ──────────────────────────────────────────────
  # JOB 1 – Install, lint and test
  # ──────────────────────────────────────────────
  lint-and-test:
    name: Lint & Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        node-version: ["20.x", "22.x"]

    steps:
      - name: Checkout code (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Cache keyed to package.json until a lock file is committed
          cache: "npm"
          cache-dependency-path: "vet-sync-api/package.json"

      - name: Install dependencies
        # Use "npm ci" once a package-lock.json is committed; "npm install" until then
        run: npm install

      - name: Run ESLint
        run: npm run lint

      - name: Run Jest tests
        # ESM projects require --experimental-vm-modules
        run: npx jest --config jest.config.cjs --passWithNoTests --forceExit
        env:
          NODE_ENV: test
          NODE_OPTIONS: --experimental-vm-modules
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

  # ──────────────────────────────────────────────
  # JOB 2 – Verify the app starts (smoke test)
  # ──────────────────────────────────────────────
  smoke-test:
    name: Smoke – node app.js
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm install

      - name: Verify app can be imported (syntax check)
        # node --check validates syntax without running the server
        run: node --check app.js
